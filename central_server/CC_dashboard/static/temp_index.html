<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Surveillance Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root { --bg:#0f172a; --fg:#e2e8f0; --card:#111827; --muted:#94a3b8; --accent:#22d3ee; --ok:#22c55e; --warn:#f59e0b; }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu; background: var(--bg); color: var(--fg); }
        header { padding: 16px 20px; border-bottom: 1px solid #1f2937; display: flex; justify-content: space-between; align-items: center; }
        header h1 { margin: 0; font-size: 20px; letter-spacing: 0.3px; }
        .container { padding: 16px; display: grid; grid-template-columns: 360px 1fr; gap: 16px; }
        .card { background: var(--card); border: 1px solid #1f2937; border-radius: 14px; padding: 14px; }
        .metric { display:flex; align-items:center; gap:10px; margin-bottom:10px; }
        .metric .dot { width:10px; height:10px; border-radius: 50%; background: var(--muted); }
        .metric .dot.ok { background: var(--ok); }
        .metric .dot.warn { background: var(--warn); }
        .metric .val { font-weight: 600; }
        .section-title { font-size: 14px; color: var(--muted); margin: 0 0 10px 0; letter-spacing: 0.4px; }
        .list { display: grid; gap: 10px; }
        .pill { display:inline-flex; padding:2px 8px; border-radius:12px; font-size:12px; border:1px solid #334155; color:#93c5fd; }
        .live-item { border:1px solid #1f2937; border-radius:12px; padding:10px; display:flex; justify-content:space-between; align-items:center; }
        .live-item .left { display:flex; flex-direction:column; gap:6px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { text-align: left; padding: 8px; border-bottom: 1px solid #1f2937; }
        th { color: var(--muted); font-weight: 600; }
        .muted { color: var(--muted); }
        .badge { display:inline-block; padding:2px 6px; border-radius:10px; border:1px solid #334155; }
        .conf { color: #a7f3d0; }
        .lp { color: #fcd34d; font-weight:600; letter-spacing: 2px; }
        .footer { padding: 10px 16px; color: var(--muted); font-size: 12px; text-align:center; }
        .ts { font-size: 12px; color: var(--muted); }
    </style>
</head>
<body>
<header>
    <h1>Surveillance Dashboard</h1>
    <div class="muted">prototype</div>
</header>

<div class="container">
    <!-- LEFT: System / Live -->
    <div class="card">
        <h3 class="section-title">System status</h3>
        <div id="metrics">
            <div class="metric"><div class="dot ok" id="dot-workers"></div><div>LPR Workers:</div><div class="val" id="workers">0</div></div>
            <div class="metric"><div class="dot" id="dot-queue"></div><div>LPR Queue:</div><div class="val" id="queue">0</div></div>
            <div class="metric"><div class="dot" id="dot-tracks"></div><div>Active Tracks:</div><div class="val" id="tracks">0</div></div>
            <div class="ts" id="metrics-ts">Last update: —</div>
        </div>

        <h3 class="section-title" style="margin-top:16px;">Live detections</h3>
        <div class="list" id="live-list"></div>
    </div>

    <!-- RIGHT: Events -->
    <div class="card">
        <h3 class="section-title">Recent events</h3>
        <table>
            <thead>
            <tr>
                <th>Event ID</th>
                <th>Object ID</th>
                <th>Class</th>
                <th>Plate</th>
                <th>Vehicle Type</th>
                <th>First Seen</th>
                <th>Last Seen</th>
            </tr>
            </thead>
            <tbody id="events-tbody"></tbody>
        </table>
        <div class="footer">Auto-refreshing every 3s</div>
    </div>
</div>



<script>
    const wsUrl = (location.protocol === "https:" ? "wss://" : "ws://") + location.host + "/ws";
    const ws = new WebSocket(wsUrl);

    const workersEl = document.getElementById("workers");
    const queueEl = document.getElementById("queue");
    const tracksEl = document.getElementById("tracks");
    const metricsTsEl = document.getElementById("metrics-ts");
    const dotWorkers = document.getElementById("dot-workers");
    const dotQueue = document.getElementById("dot-queue");
    const dotTracks = document.getElementById("dot-tracks");
    const liveList = document.getElementById("live-list");
    const eventsTbody = document.getElementById("events-tbody");

    // Keep a small cache of last live detections by track_id
    const liveMap = new Map();

    ws.onmessage = (evt) => {
        const msg = JSON.parse(evt.data);
        if (msg.type === "metrics") {
            const m = msg.data;
            workersEl.textContent = m.workers_active ?? 0;
            queueEl.textContent   = m.lpr_queue_size ?? 0;
            tracksEl.textContent  = m.active_tracks ?? 0;
            metricsTsEl.textContent = "Last update: " + (m.last_update ?? "—");

            dotQueue.className = "dot " + ((m.lpr_queue_size||0) > 0 ? "warn" : "ok");
            dotTracks.className = "dot " + ((m.active_tracks||0) > 0 ? "ok" : "");
        }
        else if (msg.type === "live") {
            const d = msg.data;
            // update cache
            liveMap.set(String(d.track_id), {
                label: d.label,
                confidence: d.confidence,
                plate: d.license_plate || null,
                ts: Date.now()
            });
            renderLive();
        }
    };

    function renderLive() {
        // Remove stale (> 10s old)
        const now = Date.now();
        for (const [tid, v] of Array.from(liveMap.entries())) {
            if (now - v.ts > 10000) liveMap.delete(tid);
        }

        liveList.innerHTML = "";
        for (const [tid, v] of Array.from(liveMap.entries()).sort((a,b)=>a[0]-b[0])) {
            const el = document.createElement("div");
            el.className = "live-item";
            el.innerHTML = `
          <div class="left">
            <div><span class="badge">ID ${tid}</span> <span class="pill">${v.label}</span></div>
            <div>Confidence: <span class="conf">${Number(v.confidence).toFixed(2)}</span></div>
            ${v.plate ? `<div>Plate: <span class="lp">${v.plate}</span></div>` : ``}
          </div>
          <div class="ts">${formatTimestamp(v.ts)}</div>
        `;
            liveList.appendChild(el);
        }
    }

    function formatTimestamp(ts) {
        // If it's already a number (epoch), convert; otherwise assume it's ISO string
        const d = new Date(ts);

        // Options for formatting
        const options = {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
            year: "numeric",
            month: "short",   // e.g. Aug
            day: "numeric"
        };

        return d.toLocaleString("en-US", options);
    }

    async function fetchMetricsInitial() {
        try {
            const r = await fetch("/api/metrics");
            const m = await r.json();
            workersEl.textContent = m.workers_active ?? 0;
            queueEl.textContent = m.lpr_queue_size ?? 0;
            tracksEl.textContent = m.active_tracks ?? 0;
            metricsTsEl.textContent = "Last update: " + (m.last_update ?? "—");
        } catch(e) {}
    }

    async function fetchEvents() {
        try {
            const r = await fetch("/api/events/recent?limit=200");
            const rows = await r.json();
            eventsTbody.innerHTML = rows.map(row => {
                const plate = row.vehicle?.license_plate ?? "";
                const vtype = row.vehicle?.vehicle_type ?? "";
                return `
            <tr>
              <td>${row.event_id}</td>
              <td>${row.object_id}</td>
              <td>${row.class_type}</td>
              <td>${plate ? `<span class="lp">${plate}</span>` : ""}</td>
              <td>${vtype || ""}</td>
              <td>${row.time_first_detected ? formatTimestamp(row.time_first_detected) : ""}</td>
              <td>${row.last_seen ? formatTimestamp(row.last_seen) : ""}</td>
            </tr>
          `;
            }).join("");
        } catch(e) {
            console.error(e);
        }
    }

    fetchMetricsInitial();
    fetchEvents();
    setInterval(fetchEvents, 3000);
</script>
</body>
</html>
